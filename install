#!/usr/bin/env python
from argparse import ArgumentParser
import libvirt
import os
from subprocess import check_call, Popen, PIPE
import sys

DOMAIN = "sr-server"
DISK = os.path.join( os.path.dirname( __file__ ), "hda" )

def guestfish( args, cmds ):
    "Run a set of guestfish commands"
    p = Popen( "guestfish " + args, shell = True,
               stdin = PIPE )
    p.communicate( cmds )
    assert p.wait() == 0

parser = ArgumentParser( description = "Build an SR VM" )
parser.add_argument( "--fedora-source",
                     help = "The source location to get Fedora files from",
                     default = "http://ftp-stud.hs-esslingen.de/pub/Mirrors/archive.fedoraproject.org/fedora/linux/releases/17/Fedora/i386/os/" )
args = parser.parse_args()

conn = libvirt.openReadOnly()
domains = [ d.name() for d in conn.listAllDomains() ]

if DOMAIN in domains:
    print >>sys.stderr, "You already have a domain called '{0}'".format( DOMAIN )
    print >>sys.stderr, "If you want to get rid of it:"
    print >>sys.stderr, "        `virsh destroy {0}`".format( DOMAIN )
    print >>sys.stderr, "    then"
    print >>sys.stderr, "        `virsh undefine {0}`".format( DOMAIN )
    exit(1)

check_call( [ "qemu-img", "create", "-f", "qcow2", "hda", "50G" ] )

# Format the boot and root disks
guestfish( "-a {0}".format( DISK ),
           """run
# Root disk
part-init /dev/sda msdos

# Root partition  -- 18GB
# Assume sector size of 512
part-add /dev/sda primary 2048 37748736

# Swap partition -- 512MB
part-add /dev/sda primary 37748737 38797313
""" )

check_call( [ "virt-install",
              "--hvm",
              "--name", DOMAIN,
              "--ram", "1023",
              "--disk", "{0},format=qcow2".format(DISK),
              "--graphics", "spice",
              "--os-variant", "fedora17",
              "--location", args.fedora_source,
              "--initrd-inject", os.path.join( os.path.dirname(__file__), "init", "ks.cfg" ),
              "--extra-args", "ks=file:/ks.cfg",
              "--noreboot" ] )

